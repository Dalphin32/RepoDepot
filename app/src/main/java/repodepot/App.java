/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package repodepot;

import java.util.Scanner;
import java.util.Arrays;
import org.bson.Document;
import org.bson.conversions.Bson;
import org.bson.types.ObjectId;
import com.mongodb.MongoException;
import com.mongodb.client.FindIterable;
import com.mongodb.client.MongoClient;
import com.mongodb.client.MongoClients;
import com.mongodb.client.MongoCollection;
import com.mongodb.client.MongoCursor;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.model.Projections;
import com.mongodb.client.result.InsertOneResult;
import static com.mongodb.client.model.Filters.eq;
import com.mongodb.client.model.Sorts;
import com.mongodb.client.model.UpdateOptions;
import com.mongodb.client.model.Updates;

import org.bson.conversions.Bson;

public class App {
    private static String current_user;

    public static void main(String[] args) {
        start();
    }


    static void start(){
        Scanner scnr = new Scanner(System.in);

        System.out.println("________________________________________________________________");
        System.out.println("    /'\\      /'''''\\   /'''''\\   /'''''\\   |'''''''\\   |'''''\\  ");
        System.out.println("   /   \\    |  ____/  |  ____/  |  |'|  |  |  | |   |  | |'|  \\ ");
        System.out.println("  /=====\\   |  |      |  |      |  | |  |  |   _   /   | | |   |");
        System.out.println(" /       \\  |  ''''\\  |  ''''\\  |  |_|  |  |  | \\  \\   | |_|  / ");
        System.out.println("/         \\  \\_____/   \\_____/   \\_____/   |__|  \\__\\  |_____/  ");
        System.out.println("________________________________________________________________");
        System.out.println("");
        System.out.println("[1] Login");
        System.out.println("[2] Sign up");
        System.out.println("[3] Shut down");
        String log_or_sign = scnr.nextLine();
        if (log_or_sign.equals("1")){
            System.out.println("Welcome!! Lets get you logged in!!");
            System.out.println("Enter your username: ");
            String userName = scnr.nextLine();  // Read user input
            System.out.println("Password: ");
            String pass = scnr.nextLine();  // Read user input
            boolean loggedIn = false;
            if(!(alreadyUsed(userName) && getUser(userName)[1].equals(pass))){
                int x = 0;
                while(x<2){
                    System.out.println("UserName or password is incorrect please re-enter");
                    System.out.println("Enter your username: ");
                    userName = scnr.nextLine();  // Read user input
                    System.out.println("Password: ");
                    pass = scnr.nextLine();  // Read user input
                    if(alreadyUsed(userName) && getUser(userName)[1].equals(pass)){
                        loggedIn = true;
                        break;
                    }
                    x++;
                }
                if(!loggedIn){
                    String newOne = "N";  // Read user input
                    while(newOne.equals("N")){
                        System.out.println("UserName or password is incorrect please re-enter");
                        System.out.println("Enter your username: ");
                        userName = scnr.nextLine();  // Read user input
                        System.out.println("Password: ");
                        pass = scnr.nextLine();  // Read user input
                        if(alreadyUsed(userName) && getUser(userName)[1].equals(pass)){
                            break;
                        }
                        System.out.println("Bro your account still isn't found you wanna create a new one?[Y or N]: ");
                        newOne = scnr.nextLine();  // Read user input
                        if(newOne.equals("Y")){
                            if(create()){
                                break;
                            }
                        }

                    }

                }
            }
            
            set_current_user(userName);
            home();

            //log in
        } else if (log_or_sign.equals("2")){

            if(create()){
                System.out.println("Your account was successfully created!!");
                home();
            }
        } else{
            System.exit(0);
        }
    }




    static Boolean create(){
        Scanner scnr = new Scanner(System.in);
        System.out.println("Welcome new user!! Lets get you an account");
            System.out.println("Please enter a username(must not contain spaces): ");
            String userName = scnr.nextLine();  // Read user input
            while(userName.contains(" ") || alreadyUsed(userName)){
                if(userName.contains(" ")){
                    System.out.println("Please enter a username(must not contain spaces): ");
                    userName = scnr.nextLine();  // Read user input
                }else{
                    System.out.println("That username is already taken please select a new one: ");
                    userName = scnr.nextLine();  // Read user input
                }
                
            }


            System.out.println("Please enter a password(must be at least 8 characters): ");
            String pass = scnr.nextLine();  // Read user input
            while(pass.length()< 8){
                System.out.println("Password must be at least 8 characters: ");
                pass = scnr.nextLine();  // Read user input
            }
            System.out.println("Please re-enter your password: ");
            String checkpass = scnr.nextLine();  // Read user input
            while(!(pass.equals(checkpass))){
                System.out.println("Your password does not match, please re-enter the correct password: ");
                checkpass = scnr.nextLine();  // Read user input
            }



            System.out.println("Please enter a security question to verify your account: ");
            String securityQuestion = scnr.nextLine();  // Read user input

            System.out.println("Please enter your bio: ");
            String bio = scnr.nextLine();  // Read user input

            System.out.println("Please enter youre name: ");
            String name = scnr.nextLine();  // Read user input
        //scnr.close();
        String uri = "mongodb+srv://emCorey:test1234@cluster0.cwb4w.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0";
        try (MongoClient mongoClient = MongoClients.create(uri)) {
            MongoDatabase database = mongoClient.getDatabase("DolphinMangoCore");
            MongoCollection<Document> collection = database.getCollection("users");
            try {
                // Inserts a sample document describing a movie into the collection
                InsertOneResult result = collection.insertOne(new Document()
                        .append("_id", new ObjectId())
                        .append("UserName", userName)
                        .append("Password", pass)
                        .append("Question", securityQuestion)
                        .append("Bio", bio)
                        .append("Name", name));
                // Prints the ID of the inserted document
                //redirect to home
                set_current_user(userName);
                return true;
            
            // Prints a message if any exceptions occur during the operation
            } catch (MongoException me) {
                return false;
            }
        }
        
    }

    static void logout(){
        System.out.println("Goodbye! :)");
        set_current_user(null);
        start();
    }

    static String[] getUser(String name){
        String uri = "mongodb+srv://emCorey:test1234@cluster0.cwb4w.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0";
        try (MongoClient mongoClient = MongoClients.create(uri)){
            MongoDatabase database = mongoClient.getDatabase("DolphinMangoCore");
            MongoCollection<Document> collection = database.getCollection("users");
            Document doc = collection.find(eq("UserName", name)).first();
            if (doc == null){
                return null;
            }
            else{
                String[] user = new String[2];
                user[0] = doc.get("UserName")+"";
                user[1] = doc.get("Password")+"";
                return user;
            }
        }
    }


    static Boolean alreadyUsed(String username){
        String uri = "mongodb+srv://emCorey:test1234@cluster0.cwb4w.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0";
        try (MongoClient mongoClient = MongoClients.create(uri)) {
            MongoDatabase database = mongoClient.getDatabase("DolphinMangoCore");
            MongoCollection<Document> collection = database.getCollection("users");
            Bson projectionFields = Projections.fields(
                    Projections.include("UserName"),
                    Projections.excludeId());
                    Document doc = collection.find(eq("UserName", username)).projection(projectionFields).first();
                    if(doc == null){
                        return false;
                    }
                    return true;
        }
    }

    public static void home(){
        Scanner scnr = new Scanner(System.in);

        System.out.println("Welcome "+get_current_user()+"!");
        System.out.println("[1] Send Message");
        System.out.println("[2] See Users");
        System.out.println("[3] Rooms");
        System.out.println("[4] Check Messages");
        System.out.println("[5] Update Profile");
        System.out.println("[6] Log out");
        String opt = scnr.nextLine();

        switch(opt){
            case "1":
                System.out.println("What user would you like to message?");
                String selected_user = scnr.nextLine();
                if (getUser(selected_user) == null){
                    System.out.println("user does not exist!");
                } else{
                    System.out.println("Enter message:");
                    String msg_body = scnr.nextLine();
                    scnr.nextLine();
                    sendMessage(msg_body,selected_user);
                    System.out.println("Message Sent!");
                }
            break;
            case "2":
                System.out.println("Users:");
                String[] users = usersInServer();
                for(int x= 1; x<users.length; x++){
                    System.out.println(x+":"+users[x]);
                }
            break;
            case "3":
                System.out.println("Here are all the rooms");
                showRooms();
                System.out.println("Do you want to add a room? (y or n)");
                String seeroom = scnr.next();
                if(seeroom.equals("y")){
                    System.out.println("What is the room name?");
                    String name = scnr.next();
                    System.out.println("What is the room description?");
                    scnr.nextLine();
                    String desc = scnr.nextLine();
                    createRoom(name, desc);
                }
            break;
            case "4":
                read_messages(get_current_user());
            break;
            case "5":
                //update profile
            break;
            case "6":
                logout();
            break;
        }
        home();
    }

    public static String[] usersInServer(){ 
        String uri = "mongodb+srv://emCorey:test1234@cluster0.cwb4w.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0";
        try (MongoClient mongoClient = MongoClients.create(uri)) {
            MongoDatabase database = mongoClient.getDatabase("DolphinMangoCore");
            MongoCollection<Document> collection = database.getCollection("users");
            long longLength = collection.countDocuments();
            int length = (int) longLength;
            String[] users = new String[length+1]; 
            try{
                Bson projectionFields = Projections.fields(
                    Projections.include("UserName"),
                    Projections.excludeId());
                Document doc = collection.find().projection(projectionFields).first();
                users[0] = doc +"";
                MongoCursor<Document> docs = collection.find().projection(projectionFields).iterator();
                for(int x = 1; x<users.length;x++){
                    try {
                        if(docs.hasNext()) {
                            users[x] = (docs.next().get("UserName")+"");
                        }
                     } finally {
                        docs.close();
                        //x = users.length;
                    }
                } 
                return users;             
            }
            catch (MongoException me) {
                System.err.println("Unable to insert due to an error: " + me);
            }
        }
        return null; 
    }

    public static void sendMessage(String body, String user){
        String uri = "mongodb+srv://emCorey:test1234@cluster0.cwb4w.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0";
        try (MongoClient mongoClient = MongoClients.create(uri)) {
            MongoDatabase database = mongoClient.getDatabase("DolphinMangoCore");
            MongoCollection<Document> collection = database.getCollection("messages");
            try{
                InsertOneResult message = collection.insertOne(new Document()
                .append("text",body)
                .append("user",user)
                .append("sent_by",get_current_user())
                );
            }
            catch (MongoException me) {
                System.err.println("Unable to insert due to an error: " + me);
            }
        }
    }
    public static void read_messages(String user){
        String uri = "mongodb+srv://emCorey:test1234@cluster0.cwb4w.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0";
        try (MongoClient mongoClient = MongoClients.create(uri)) {
            MongoDatabase database = mongoClient.getDatabase("DolphinMangoCore");
            MongoCollection<Document> collection = database.getCollection("messages");
            Bson projectionFields = Projections.fields(Projections.excludeId());
            MongoCursor<Document> cursor = collection.find(eq("user",user))
                    .projection(projectionFields)
                    .sort(Sorts.descending("id")).iterator();
            try {
                System.out.println("________________________________________________________________________________");
                while(cursor.hasNext()) {
                    Document next = cursor.next();
                    System.out.print(next.get("sent_by")+": ");
                    System.out.println(next.get("text"));
                    System.out.println("________________________________________________________________________________");
                }
            } finally {
                cursor.close();
                home();
            }
        }
    }

    public static void createRoom(String roomName, String description){
        String uri = "mongodb+srv://emCorey:test1234@cluster0.cwb4w.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0";
        try (MongoClient mongoClient = MongoClients.create(uri)) {
            MongoDatabase database = mongoClient.getDatabase("DolphinMangoCore");
            MongoCollection<Document> collection = database.getCollection("rooms");
            try {
                // Inserts a sample document describing a movie into the collection
                InsertOneResult result = collection.insertOne(new Document()
                        .append("_id", new ObjectId())
                        .append("name:", roomName)
                        .append("decription:", description));
                // Prints the name of the inserted document
                System.out.println("Success! you created the " + roomName + " room." );
                System.out.println("Name: " + roomName);
                System.out.println("Description: " + description);
                home();
            
            // Prints a message if any exceptions occur during the operation
            } catch (MongoException me) {
                System.err.println("Unable to insert due to an error: " + me);
            }
        }
        /*if(createRoom(roomName, description)){
            home();
        }*/
    }
    
    public static void showRooms(){
        String uri = "mongodb+srv://emCorey:test1234@cluster0.cwb4w.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0";
        try (MongoClient mongoClient = MongoClients.create(uri)) {
            MongoDatabase database = mongoClient.getDatabase("DolphinMangoCore");
            MongoCollection<Document> collection = database.getCollection("rooms");
            MongoCursor<Document> cursor = collection.find()
                .sort(Sorts.descending("name:")).iterator();
            try {
                while(cursor.hasNext()){
                    System.out.println(cursor.next().getString("name:"));
                }
            } catch (MongoException me) {
                System.err.println("Unable to read due to an error: " + me);
            }finally {
                cursor.close();
            }
        }
        
    }

    public static void set_current_user(String user){
        current_user = user;
    }
    public static String get_current_user(){
        return current_user;
    }
}




/*String connectionString = "mongodb+srv://emCorey:test1234@cluster0.cwb4w.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0";
        try (MongoClient mongoClient = MongoClients.create(connectionString)) {
            MongoDatabase database = mongoClient.getDatabase("DolphinMangoCore");
            MongoCollection<Document> collection = database.getCollection("users");
            
            
        }*/
